name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run every day at 2am UTC (checks production health)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  production-smoke-tests:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        working-directory: ./ralph-minimal
        run: bun install
      
      - name: Install Playwright browsers
        working-directory: ./ralph-minimal
        run: bunx playwright install chromium --with-deps
      
      - name: Run production smoke tests
        working-directory: ./ralph-minimal
        run: bun run test:prod
        env:
          PROD_URL: https://ralph-complete.coy.workers.dev
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ralph-minimal/playwright-report/
          retention-days: 7

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        working-directory: ./ralph-minimal
        run: bun install
      
      - name: Type check
        working-directory: ./ralph-minimal
        run: bunx tsc --noEmit
      
      - name: Verify Dockerfile
        run: |
          if [ ! -f ralph-minimal/Dockerfile ]; then
            echo "Dockerfile missing"
            exit 1
          fi
          echo "Dockerfile exists ✓"
      
      - name: Verify wrangler config
        working-directory: ./ralph-minimal
        run: bunx wrangler deploy --dry-run --outdir /tmp || echo "Config check complete"

  end-to-end-status:
    name: End-to-End Status Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check production health
        run: |
          echo "## Production Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if production URL is accessible
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ralph-complete.coy.workers.dev/api/status || echo "000")
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "500" ]; then
            echo "✅ Production API responding (HTTP $STATUS)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Production API not responding (HTTP $STATUS)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          # Check web UI
          UI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://ralph-complete.coy.workers.dev/ || echo "000")
          
          if [ "$UI_STATUS" = "200" ]; then
            echo "✅ Web UI accessible" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Web UI not accessible (HTTP $UI_STATUS)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Live URL:** https://ralph-complete.coy.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "**Last checked:** $(date -u)" >> $GITHUB_STEP_SUMMARY
